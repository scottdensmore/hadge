name: Secret Scan History

on:
  schedule:
    - cron: "23 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gitleaks_history:
    name: Gitleaks History
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install gitleaks
        run: |
          set -euo pipefail
          VERSION="8.24.2"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" | tar -xz
          sudo install -m 0755 gitleaks /usr/local/bin/gitleaks
      - name: Run full-history gitleaks scan
        run: |
          set -euo pipefail
          gitleaks git \
            --config .gitleaks.toml \
            --redact \
            --log-opts="--all" \
            --report-format sarif \
            --report-path gitleaks-history.sarif
      - name: Upload gitleaks SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-history-sarif
          path: gitleaks-history.sarif
